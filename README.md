# wiki-image-proxy
一个给 HydCraft Wiki 写的代理层，用来给图片中转的，具体的代理方式是代理图片请求到腾讯云的对象存储桶，以解决源站宽带吞吐量太小的问题。技术上选择了 Node 作为实现语言。

## 环境
* MediaWiki
* 基本的 Node 环境和腾讯云对象存储
* 要和 MediaWiki 跑在一个机子下
* 腾讯云对象存储（如果是腾讯云主机，这样主机和对象存储处于同一地域，可以走内网）

## 用途
代理层的任务很简单，大致流程如下：

- 首先搭建和部署本项目，以及配置好对象存储相关的数据。
- 随后在 MediaWiki 的 `LocalSettings.php` 里修改附件服务器地址为部署本项目的服务器。
- 收到请求后，项目首先检测 MediaWiki 站点文件夹内有没有被请求的图片，如果有，那就继续检查对象存储桶内是否有这个文件，如果没有，则暂时返回原链，此时立刻上传文件至腾讯云对象存储；如果有，直接重定向到对象存储桶的访问链接。
- 图片的缓存通过腾讯云对象存储的缓存机制实现，缓存时间设置为 30 天，缓存过期后，再次访问图片时，会重新上传图片至对象存储桶。
- 但是项目本身也有一层缓存，图片会到了某个时间自动刷新一次，因为 MediaWiki 本身是允许同名文件二次上传的。

你可能会问，为啥不直接用 CDN？**因为贵啊。**腾讯云的 CDN 比对象存储可不是贵一点半点，对象存储除了下行宽带费用贵一点其他真的还好。

而且我们源站是国内轻量主机，宽带太小了，有时候 Wiki 里面来好几张图片要加载很久；直接用对象存储的扩展又会严重拖慢 MediaWiki 的运行效率。只能这么做，就当作缓存了。

## 进度
* 大概 2024-12 月底前完成。